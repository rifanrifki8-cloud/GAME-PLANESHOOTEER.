<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar Ace - Mobile Plane Shooter</title>

    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #222;
            overflow: hidden;
            user-select: none;
            touch-action: manipulation;
            flex-direction: column; /* Atur layout vertikal */
        }

        #game-container {
            position: relative;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            margin-top: 10px;
        }

        #gameCanvas {
            background-color: #000;
            display: block;
            border: 1px solid #00f;
        }

        #score {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-family: sans-serif;
            font-size: 18px;
            z-index: 10;
        }

        /* KONTROL MOBILE */
        #mobile-controls {
            width: 375px; /* Sama dengan lebar kanvas */
            height: 150px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            box-sizing: border-box;
            z-index: 20;
            pointer-events: none;
        }

        /* Joystick (Analog) */
        #joystick-base {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            position: relative;
            pointer-events: auto;
            margin-left: 10px;
        }

        #joystick-knob {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.6);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Tombol Tembak */
        #fire-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #ff3333;
            color: white;
            border: 4px solid #cc0000;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            pointer-events: auto;
            margin-right: 10px;
            user-select: none;
        }

        #fire-button:active {
            background-color: #cc0000;
            transform: scale(0.95);
        }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas" width="375" height="667"></canvas>
        <div id="score">Score: 0</div>
    </div>

    <div id="mobile-controls">
        <div id="joystick-base">
            <div id="joystick-knob"></div>
        </div>

        <button id="fire-button">
            ðŸš€
        </button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        const WIDTH = canvas.width;
        const HEIGHT = canvas.height;
        let gameLoopId;

        // --- Variabel State Game ---
        let player = {
            x: WIDTH / 2,
            y: HEIGHT - 100,
            width: 30,
            height: 40,
            speed: 4, // Kecepatan gerak pemain
            dx: 0, // Perubahan X dari joystick
            dy: 0  // Perubahan Y dari joystick
        };
        let bullets = [];
        let enemies = [];
        let score = 0;
        let isGameOver = false;

        let lastEnemySpawn = 0;
        const ENEMY_SPAWN_RATE = 1000; // setiap 1 detik
        const MAX_BULLETS = 5;


        // --- Fungsi Gambar (Draw Functions) ---
        function drawPlayer() {
            ctx.fillStyle = 'cyan';
            ctx.fillRect(player.x - player.width / 2, player.y - player.height / 2, player.width, player.height);
        }

        function drawBullets() {
            ctx.fillStyle = 'yellow';
            bullets.forEach(bullet => {
                ctx.fillRect(bullet.x - 2, bullet.y - 5, 4, 10);
            });
        }

        function drawEnemies() {
            ctx.fillStyle = 'red';
            enemies.forEach(enemy => {
                ctx.fillRect(enemy.x - enemy.width / 2, enemy.y - enemy.height / 2, enemy.width, enemy.height);
            });
        }
        
        function drawGameOver() {
            ctx.fillStyle = 'white';
            ctx.font = '30px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('GAME OVER', WIDTH / 2, HEIGHT / 2);
            ctx.font = '20px Arial';
            ctx.fillText('Tap to Restart', WIDTH / 2, HEIGHT / 2 + 40);
        }


        // --- Fungsi Update Logika (Update Functions) ---
        
        function updatePlayer() {
            // Memperbarui posisi berdasarkan input joystick
            player.x += player.dx * player.speed;
            player.y += player.dy * player.speed;

            // Batasi pemain di dalam kanvas
            if (player.x < player.width / 2) player.x = player.width / 2;
            if (player.x > WIDTH - player.width / 2) player.x = WIDTH - player.width / 2;
            if (player.y < player.height / 2) player.y = player.height / 2;
            if (player.y > HEIGHT - player.height / 2) player.y = HEIGHT - player.height / 2;
        }

        function updateBullets() {
            bullets.forEach((bullet, index) => {
                bullet.y -= bullet.speed;
                // Hapus peluru yang keluar layar
                if (bullet.y < 0) {
                    bullets.splice(index, 1);
                }
            });
        }

        function updateEnemies() {
            enemies.forEach((enemy, index) => {
                enemy.y += enemy.speed;
                // Hapus musuh yang keluar layar
                if (enemy.y > HEIGHT) {
                    enemies.splice(index, 1);
                }
            });
        }

        function spawnEnemy(timestamp) {
            if (timestamp - lastEnemySpawn > ENEMY_SPAWN_RATE) {
                const x = Math.random() * (WIDTH - 40) + 20;
                enemies.push({
                    x: x,
                    y: 0,
                    width: 30,
                    height: 30,
                    speed: Math.random() * 2 + 1
                });
                lastEnemySpawn = timestamp;
            }
        }
        
        // --- Deteksi Tabrakan (Collision Detection) ---
        function checkCollisions() {
            // 1. Peluru vs Musuh
            bullets.forEach((bullet, bIndex) => {
                enemies.forEach((enemy, eIndex) => {
                    // Cek tabrakan sederhana (AABB: Axis-Aligned Bounding Box)
                    if (bullet.x < enemy.x + enemy.width / 2 &&
                        bullet.x + 4 > enemy.x - enemy.width / 2 &&
                        bullet.y < enemy.y + enemy.height / 2 &&
                        bullet.y + 10 > enemy.y - enemy.height / 2) 
                    {
                        // Tabrakan terjadi!
                        bullets.splice(bIndex, 1); // Hapus peluru
                        enemies.splice(eIndex, 1); // Hapus musuh
                        score += 10;
                    }
                });
            });

            // 2. Pemain vs Musuh
            enemies.forEach(enemy => {
                if (player.x < enemy.x + enemy.width / 2 &&
                    player.x + player.width / 2 > enemy.x - enemy.width / 2 &&
                    player.y < enemy.y + enemy.height / 2 &&
                    player.y + player.height / 2 > enemy.y - enemy.height / 2) 
                {
                    // Tabrakan pemain! Game Over
                    isGameOver = true;
                    cancelAnimationFrame(gameLoopId);
                }
            });
        }


        // --- Input Touch / Joystick ---
        const joystickBase = document.getElementById('joystick-base');
        const joystickKnob = document.getElementById('joystick-knob');
        const FIRE_BUTTON = document.getElementById('fire-button');
        const JOYSTICK_RADIUS = joystickBase.offsetWidth / 2; // 50px

        function fireBullet() {
            if (bullets.length < MAX_BULLETS && !isGameOver) {
                bullets.push({
                    x: player.x,
                    y: player.y - player.height / 2,
                    speed: 10 // Kecepatan peluru
                });
            }
        }

        // Tombol Tembak
        FIRE_BUTTON.addEventListener('touchstart', (e) => {
            e.preventDefault(); 
            fireBullet();
        });

        // Logika Joystick
        function handleJoystick(e) {
            if (isGameOver) return;
            const touch = e.touches[0];
            const rect = joystickBase.getBoundingClientRect();

            const centerX = rect.left + JOYSTICK_RADIUS;
            const centerY = rect.top + JOYSTICK_RADIUS;
            let deltaX = touch.clientX - centerX;
            let deltaY = touch.clientY - centerY;
            let distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);

            // Batasi knob
            if (distance > JOYSTICK_RADIUS) {
                let angle = Math.atan2(deltaY, deltaX);
                deltaX = Math.cos(angle) * JOYSTICK_RADIUS;
                deltaY = Math.sin(angle) * JOYSTICK_RADIUS;
                distance = JOYSTICK_RADIUS;
            }

            // Pindahkan knob
            joystickKnob.style.transform = `translate(${deltaX}px, ${deltaY}px)`;

            // Normalisasi nilai delta untuk kontrol pemain (-1 sampai 1)
            player.dx = deltaX / JOYSTICK_RADIUS;
            player.dy = deltaY / JOYSTICK_RADIUS;

            e.preventDefault(); 
        }

        function resetJoystick() {
            // Kembalikan knob ke tengah
            joystickKnob.style.transform = `translate(-50%, -50%)`;
            // Hentikan pergerakan pemain
            player.dx = 0;
            player.dy = 0;
        }

        joystickBase.addEventListener('touchstart', handleJoystick);
        joystickBase.addEventListener('touchmove', handleJoystick);
        joystickBase.addEventListener('touchend', resetJoystick);

        // Restart Game saat Game Over
        canvas.addEventListener('click', () => {
            if (isGameOver) {
                resetGame();
            }
        });


        // --- Game Loop dan Setup ---
        
        function resetGame() {
            player.x = WIDTH / 2;
            player.y = HEIGHT - 100;
            bullets = [];
            enemies = [];
            score = 0;
            isGameOver = false;
            lastTime = 0;
            document.getElementById('score').textContent = `Score: 0`;
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        let lastTime = 0;

        function gameLoop(timestamp) {
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;

            // 1. Bersihkan Canvas
            ctx.clearRect(0, 0, WIDTH, HEIGHT);

            // 2. Pembaruan (Update)
            updatePlayer();
            updateBullets();
            updateEnemies();
            spawnEnemy(timestamp);

            // 3. Deteksi Tabrakan
            checkCollisions();

            // 4. Gambar (Draw)
            drawEnemies();
            drawBullets();
            drawPlayer();

            // Perbarui Skor
            document.getElementById('score').textContent = `Score: ${score}`;

            // Lanjutkan Loop
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        // Mulai Game
        window.onload = () => {
            resetGame();
        };

    </script>
</body>
</html>
